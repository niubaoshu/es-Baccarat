# EZ Baccarat (免佣百家乐) 游戏模拟器需求文档

本文档根据加州官方 EZ Baccarat 规则文件提取，旨在为 Go 语言实现该游戏模拟器提供完整的业务逻辑和核心规则参照。

## 1. 游戏基础设置与卡牌规则
* **牌具使用**: 使用标准的 52 张扑克牌（无大小王）。单靴牌（Shoe）中可包含 3 到 8 副牌。
* **牌靴配置与消耗规则 (Shoe Configuration & Burning / Penetration Rules)**:
  * *(开发新增需求)* 系统配置文件需支持配置**初始使用的副牌数量 (Number of Decks, 3-8)**。
  * **切牌/烧牌（Burn Cards）与 牌靴穿透率（Deck Penetration / Cut Card）**：在此份加州司法部批准的官方核心**玩法规则文档 (Game Rules) 中，并没有硬性规定**每靴牌开始必须要销掉几张牌，也没有规定最后必须剩余几张牌不发（通常用红色切牌卡 Cut Card 标记）。
  * *(开发新增需求)* 由于实际赌场中为了防作弊一定会销牌和保留尾牌，因此需要在配置中额外增加两个参数以支持真实的物理模拟：
    * `BurnCardsCount`: 新牌靴启用时，根据第一张翻出牌的点数（或固定张数），切除不用的牌的数量。
    * `RemainingCardsToShuffle`: 牌靴末端预留不发的安全牌数量（即触发重新洗牌的阈值，一般在14张或大约一副牌的厚度）。
* **卡牌点数计算**:
  * `2` 到 `9` 保持牌面点数。
  * `10`、`J`、`Q`、`K` 计为 0 点。
  * `Ace` (A) 计为 1 点。
* **手牌总点数计算**: 将手中所有牌的点数相加，如果总和达到或超过 10，则只取个位数（例如，总和为 18，则计为 8 点）。目标是使手牌总点数尽可能接近 9。

## 2. 投注类型 (Betting Options)
玩家在发牌前可以进行下注，主要有以下几种类型：
* **闲家 (Player Line)**
* **庄家 (Dealer/Banker Line)**
* **和局 (Tie)**: 可以在未下注庄/闲的情况下独立下注（需核实具体赌场是否允许，加州 Panda 8 补充文件中提到可以独立下注）。
* **龙七 (Dragon 7)**: 只有在下注了闲家或庄家后，才能下注龙七。定义：庄家以**三张牌**且总点数为 **7** 赢得该局。
* **熊猫8 (Panda 8)**: 只有在下注了闲家或庄家后，才能下注熊猫8（不允许 Back-line betting）。定义：闲家以**三张牌**且总点数为 **8** 赢了庄家（即庄家为7点或以下）。

## 3. 发牌与补牌规则 (Dealing and Hitting Rules)

### 3.1 初始发牌
* 游戏开始时，荷官交替发牌：闲家一张、庄家一张、闲家一、庄家一。
* 双方起手各获得两张处于翻开（明牌）状态的牌。

### 3.2 天生赢家 (Natural 8 or 9)
* 如果闲家或庄家在起手的前两张牌中总点数达到了 8 或 9，称为“天生赢家 (Natural)”。
* 出现天生赢家时，**双方均不允许再补第三张牌**，直接比较点数定胜负。

### 3.3 闲家补牌规则 (Player's Hand)
在前两张牌非天生赢家（即没有 8 或 9）的情况下：
* 若闲家点数为 **0 到 5**：闲家必须补牌（Hit），获得第三张牌。
* 若闲家点数为 **6 到 9**：闲家必须停牌（Stand），不补牌。

### 3.4 庄家补牌规则 (Dealer's Hand)
庄家的补牌逻辑不仅取决于自身的点数，还受到闲家行为的影响：

**情形 A：若闲家停牌（即闲家前两张牌为 6 或 7）**
* 庄家点数为 **0 到 5**：庄家必须补牌。
* 庄家点数为 **6 到 7**：庄家停牌。

**情形 B：若闲家补牌（闲家拿了第三张牌）**
此时庄家是否补牌，取决于**闲家抽到的第三张牌的点数**：
* 庄家点数为 **0、1、2**：一律补牌。
* 庄家点数为 **3**：如果闲家的第三张牌是 `8`，则庄家停牌；否则庄家补牌。
* 庄家点数为 **4**：如果闲家的第三张牌是 `0, 1, 8, 9`，则庄家停牌；如果是 `2, 3, 4, 5, 6, 7` 则庄家补牌。
* 庄家点数为 **5**：如果闲家的第三张牌是 `4, 5, 6, 7` 则庄家补牌；其他牌庄家停牌。
* 庄家点数为 **6**：如果闲家的第三张牌是 `6, 7` 则庄家补牌；其他牌庄家停牌。
* 庄家点数为 **7**：庄家一律停牌。

*注：最多每方只允许拥有 3 张牌。完成上述逻辑后即结束发牌并结算。*

## 4. 胜负判定与赔付规则 (Resolution and Payouts)
完成补牌后，点数更接近 9 的一方获胜。如双方点数相同则为“和局”。

### 4.1 常规结赛情况
* **闲家胜 (Player Win)**: 
  * 闲家注：1 赔 1
  * 庄家注、和局注、龙七注：全部输掉
  * *(注：如果闲家获胜满足熊猫8条件，则熊猫8注赢，否则输)*
* **庄家胜（非龙七情况） (Dealer Win)**:
  * 庄家注：1 赔 1
  * 闲家注、和局注、龙七注、熊猫8注：全部输掉
* **和局 (Tie)**:
  * 和局注：1 赔 8
  * 闲家注、庄家注：平局退回（Push）
  * 龙七注、熊猫8注：全部输掉

### 4.2 特殊免佣与附加玩法情况：龙七 (Dragon 7)
EZ Baccarat 的核心特色在于取消了传统百家乐庄家获胜时的 5% 抽水（免佣），取而代之的是“龙七”规则。同时，此版本（EZ Baccarat Panda 8）增加了对应闲家的“熊猫8”附加注。

**情况一：龙七成立 (Dragon 7)**
* **条件**: **庄家**经过补牌后拥有**三张牌**，且总点数恰好为 **7**，并且赢了闲家（闲家为6点或以下）。
* **赔付**:
  * 龙七注：1 赔 40
  * 庄家注：**平局退回（Push, 即不输不赢）** - 这代替了传统的抽水机制。
  * 闲家注、和局注、熊猫8注：全部输掉

**情况二：熊猫8成立 (Panda 8)**
* **条件**: **闲家**经过补牌后拥有**三张牌**，且总点数恰好为 **8**，并且赢了庄家（庄家为7点或以下）。
* **赔付**:
  * 熊猫8注：1 赔 25
  * 闲家注：1 赔 1（正常赢钱）
  * 庄家注、和局注、龙七注：全部输掉

## 5. 命令行交互与玩家会话管理 (CLI Interaction and Player Management)
根据需求，为了让玩家能够直接和程序对局并拥有完善的数据持久化，系统需要增加以下核心功能：

### 5.1 玩家建档与启动命令行参数
游戏启动时需要支持指定的命令行参数，以便程序知道“当下是谁在玩”，同时支持动态创建新玩家或设置初始资金：
* `player`:指定当前进行游戏的玩家用户名。程序会根据此名字去查找对应的玩家状态文件。如果存在，则加载其历史余额数据；如果不存在，则提示玩家需要创建新账户。**如果启动时未提供任何参数，程序将自动启用（或隐式创建）一个名为 `default_player` 的默认账户以便快速开始游戏。**
* `create_player`: 如果附带此参数，程序将创建名为 `player` 参数指定的全新玩家账户。
* `initial_balance`: 仅在与 `create_player` 配合使用时生效，为新建玩家设定初始账户余额（例如 10000 筹码）。作为安全保护，已经在系统中的老玩家不能通过该指令强行修改余额。

### 5.2 命令行对局交互流 (CLI Gameplay Loop)
* 每开始一局新游戏前，系统要在命令行终端（Terminal）向玩家展示当前的账户余额。
* 系统需通过命令行询问并接收玩家本局想要下注的**类型**和相应的**金额**（例如：Player: 100, Dragon 7: 10）。
* 结算时，将庄闲开牌结果、各个注项的结果以及该局的盈亏详细输出给玩家。
* **对局总结输出 (Round Summary)**：每局比赛彻底结束后，必须在命令行清晰打印本局的总结报告。报告应包含：本局起始余额、所有的下注分布、该局最终开牌点数（庄和闲各有几点，是否有天生赢家、是否有补牌）、每个注单是输是赢（及金额变化）、本局净盈亏额以及结算后的最新总余额。

### 5.3 玩家数据持久化 (Data Persistence)
玩家的所有行为数据需要被分类存储在外部文件中（建议采用 JSON、CSV 或 SQLite 格式）：
* **玩家状态文件 (Player Profile/Stats File)**：
  * 单独的文件，专门用于记录玩家最新的 `Balance`（总余额）、总计游戏局数、总下注额、总盈利额等宏观分析数据。
* **游戏对局流水记录表 (Game History Log File)**：
  * 单独的文件，按局为单位记录非常详细的流水。包含内容：局号、时间戳、靴号、该局下注的所有项及各自金额、庄闲最终点数/牌型、该局所有注目的赢输情况、单局总盈亏额。

## 6. 用于 Go 语言模拟器开发的核心模型与配置建议
根据上述需求，建议开发者在 Go 系统中建立以下核心实体/逻辑块：
1. `GameConfig` 结构体：
    - `DecksCount`: 牌靴使用的副牌数（例如 8）。
    - `BurnCountRule`: 销牌规则（例如拔出第一张牌视作点数销掉同等数量的牌）。
    - `CutCardThreshold`: 触发游戏结束重新洗牌的最后剩余牌数。
2. `PlayerProfile` 结构体：负责管理余额 `Balance` 及序列化操作（读取/写入状态文件）。
3. `GameLogger`：管理每局详尽流水的记录系统，负责把每手结果格式化写入对局流水文件中。
4. `Card` 结构体：表示花色和面值，并实现获取游戏点数（0-9）的方法。
5. `Deck/Shoe` 管理器：初始化并洗切 `DecksCount` 副牌，执行销牌逻辑，处理发牌状态，并在剩余牌数低于 `CutCardThreshold` 时发出靴牌结束信号。
6. `Hand` 结构体：保存当前两张或三张手牌，提供 `TotalPoints() int` 及 `IsNatural() bool` 等简捷计算。
7. `Table / GameRuleState`：用于记录每个玩家的各类型下注，并按规则引擎分发判定：
    - `CalculatePayouts()`：根据胜方点数、是否为 Dragon 7 进行 筹码的赔付/退回计算。
    - （进阶）实现加州特有的庄家轮换 (Player-Dealer Rotation) 和注码不足条件下的行动顺位算法 (`Action Button` 逻辑）。但在纯粹的数学或者发牌模拟器中可先略过此部分，专注赔率和发牌。

## 7. 概率与期望值验证表 (Mathematical Probability Reference)
为了验证模拟器核心逻辑的准确性，可以参考以下基于标准 8 副牌的穷举数学计算概率表（此表中的 Player Wins 已合并计算了闲输给龙七以外的所有赢的情况，包含 Panda 8 的本身开牌率）：

| 下注项 (Betting Option) | Combinations (组合数) | Probability (概率) | 单押期望收益率 (Return / EV) |
| :--- | :--- | :--- | :--- |
| **Banker** (赢在非龙七) | 2,179,619,555,108,870 | `0.436064` | `0.436064(赢) - 0.446247(输) = -0.010183` (-1.02%) |
| **Dragon 7** (庄3张7点赢)| 112,633,011,329,024 | `0.022534` | `0.022534x40 - 0.977466(输) = -0.076106` (-7.61%) |
| **Tie** (和局) | 475,627,426,473,216 | `0.095156` | `0.095156x8 - 0.904844(输) = -0.143596` (-14.36%) |
| **Player** (包含熊猫8) | 2,230,518,282,592,250 | `0.446247` | `0.446247(赢) - 0.458598(输) = -0.012351` (-1.24%) |
| ↳ *Panda 8* (闲3张8点赢)| *172,660,763,262,976* | *`0.034543`* | *`0.034543x25 - 0.965457(输) = -0.101882`* (-10.19%) |
| **Total** (总计组合数) | 4,998,398,275,503,360 | `1.000000` | - |

### 7.1 单押期望收益率 (Expected Value / EV) 计算公式说明

**数学期望边缘 (House Edge / Expected Return) 的计算公式为：**
`EV = (获胜概率 × 赔率) - 输掉本金的概率`

基于上述组合穷举，各项在标准定规下的赌场抽水优势与 EV 劣势非常清楚：
* **Banker (庄)**: `0.436064 (赢率) × 1 - 0.446247 (闲赢导致的输率) = -0.010183 (劣势 1.02%)`
  *(注意：龙七和和局都会退本金，所以赢余和亏本率都不包含 `0.022534` 与 `0.095156`)*
* **Player (闲)**: `0.446247 (赢率) × 1 - (0.436064 + 0.022534) (所有的庄赢和龙七带来的输率) = -0.012351 (劣势 1.24%)`
* **Tie (和)**: `0.095156 (开出和局概率) × 8 - 0.904844 (非和局输掉本金概率) = -0.143596 (劣势 14.36%)`
* **Dragon 7 (龙七)**: `0.022534 (开出概率) × 40 - 0.977466 (非龙七本金输掉概率) = -0.076106 (劣势 7.61%)`
* **Panda 8 (熊猫8)**: `0.034543 (开出概率) × 25 - 0.965457 (非熊猫8本金输掉概率) = -0.101882 (劣势 10.19%)`

*注：程序的大数据模拟（Monte Carlo Simulation）输出结果应与上述 Probability 误差控制在万分之一极值以内，以证明发牌补牌引擎的完全准确。*

---

## 8. 附录：核心业务讨论与边界避坑指南 (Development Insights)

在系统实际的规则提取、引擎测试及数学概率核准过程中，针对最初的加州赌博控制局官方文件及概率数学模型，我们总结了以下绝不可忽略的关键业务结论以备后查：

### 8.1 关于 Panda 8 不在初始规则文件中的出处
* 最初审核加州 BGC（Bureau of Gambling Control）基础版本的 EZ Baccarat 参考文档（`BGC_ez_baccarat.pdf`）时，系统仅涵盖了核心免佣规则和“Dragon 7”。
* “Panda 8”（闲家3张牌8点赢，1赔25）是随后引入的核心边注玩法。其完全被记录在了一份**单独的、针对 Panda 8 变种的补充批准文件**（`BGC_ez_baccarat_panda_8.pdf`）中。
* **业务约束**：在该版本规则中，允许和局（Tie）作为独立注码空下手，但在一些赌场中（或取决于其具体的内部安全策略），附加注码（Dragon/Panda）强制要求绑定在主要的庄/闲下注项上。

### 8.2 关于 Player (闲家) 总胜率中的 Panda 8 包含关系
* **概率表象的误区**：在第三方的权威数学或赌场分析报表中，`Player wins`（闲家胜）的总合并概率通常在 `44.62%` 左右。此数字乍看之下似乎缺少了 Panda 8 的专门概率。
* **引擎设计必读**：实际上，Panda 8 的根定义是**“闲家胜出的特定子集（三张且8点）”**。因此，数学表中那 `44.62%` 的闲赢总概率，**已经包含了开出 Panda 8（约 `3.45%`）的所有组合情况**。
* 在程序输出与结果结算时，对于系统引擎设计尤为重要的是：**若开出 Panda 8，系统结算必须向押了“Panda 8”的筹码赔付 25 倍，且“必须”同时向押了“Player (基础闲家注)”的筹码正常赔付 1 倍本金。不可将两者视作互斥或吞掉基础闲家注！**

### 8.3 纯逻辑系统中的最易错点 (The "Natural" Check Bypass Bug)
* 赌桌庄家补第三张牌（`DetermineBankerHit`）的规则矩阵极为复杂，开发中最容易犯的错误是**完全根据该矩阵死算，而忘记拦截最顶层的规则覆盖**。
* **天生赢家（Natural 8/9）的最高优先级**：如果发出的前两张牌中，闲家或庄家有任何一方达到了 8点 或 9点（即天生赢家），**无论矩阵图指向什么要求（比如庄家仅有2点或3点等必补牌的点数），均立刻锁死该局，直接比大小，决不允许任何一方再拿第三张牌。**
* 在进行蒙特卡洛引擎的大数据回归测试时，曾因为漏加这一行拦截代码引发了 `Player` 胜出率相比基准低了将近 1.3% 的微小扭曲，此教训被代码 `rules/action.go` 中的顶层 If 防御机制永久写死。
